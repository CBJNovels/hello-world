name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é…è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚v1.0.0

# å¿…é¡»çš„å‘å¸ƒæƒé™é…ç½®
permissions:
  contents: write  # å…è®¸åˆ›å»ºreleaseå’Œtag

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å‡†å¤‡æ„å»ºç›®å½•
      run: mkdir -p bin  # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨

    - name: å®‰è£…ä¾èµ–ï¼ˆWindowsï¼‰
      if: matrix.os == 'windows-latest'
      run: |
        choco install mingw -y
        choco install cppcheck -y

    - name: å®‰è£…ä¾èµ–ï¼ˆLinuxï¼‰
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck

    - name: é™æ€ä»£ç åˆ†æ
      run: |
        mkdir -p reports
        cppcheck --enable=all --xml-version=2 src/ 2> reports/cppcheck-report-${{ matrix.os }}.xml

    - name: ä¸Šä¼ åˆ†ææŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: release-cppcheck-reports-${{ matrix.os }}
        path: reports/

    - name: æ„å»ºéªŒè¯ï¼ˆLinuxï¼‰
      if: matrix.os == 'ubuntu-latest'
      run: |
        make linux
        ls -lh bin/  # éªŒè¯æ„å»ºäº§ç‰©å­˜åœ¨
        file bin/hello-world  # éªŒè¯æ–‡ä»¶ç±»å‹

    - name: æ„å»ºéªŒè¯ï¼ˆWindowsï¼‰
      if: matrix.os == 'windows-latest'
      run: |
        make windows
        dir bin\  # æ˜¾ç¤ºç›®å½•å†…å®¹
        powershell -command "Get-Item bin\hello-world.exe | Select-Object FullName,Length"

    - name: å‘å¸ƒæ­£å¼ç‰ˆæœ¬
      uses: softprops/action-gh-release@v2  # ä½¿ç”¨æœ€æ–°v2ç‰ˆæœ¬
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |  # å¤šè¡Œæè¿°æ”¯æŒ
          ### ç¨³å®šç‰ˆæœ¬å‘å¸ƒ
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}
        draft: false
        prerelease: false
        files: |
          ${{ github.workspace }}/bin/hello-world.exe
          ${{ github.workspace }}/bin/hello-world
        retries: 3  # æ˜¾å¼å£°æ˜é‡è¯•æ¬¡æ•°
        retry_wait: 5000  # é‡è¯•é—´éš”(ms)
        fail_on_unmatched_files: true  # æ–‡ä»¶ç¼ºå¤±æ—¶å¤±è´¥

# é”™è¯¯å¤„ç†å·¥ä½œæµ
error-handler:
  needs: build
  if: ${{ failure() }}
  runs-on: ubuntu-latest
  steps:
    - name: å‘é€æ„å»ºå¤±è´¥é€šçŸ¥
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ğŸš¨ Releaseæ„å»ºå¤±è´¥ï¼è¯·æ£€æŸ¥ [å·¥ä½œæµè¿è¡Œ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
          })