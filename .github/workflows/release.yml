name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # ä¸¥æ ¼åŒ¹é…è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚v1.0.0ï¼‰

# å¿…é¡»çš„æƒé™é…ç½®
permissions:
  contents: write  # å…è®¸åˆ›å»ºreleaseå’Œä¸Šä¼ æ–‡ä»¶
  checks: write    # å…è®¸æäº¤æ£€æŸ¥ç»“æœ

jobs:
  build-and-release:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]  # åŒå¹³å°æ„å»º
        include:
          - os: ubuntu-latest
            target: linux
            artifact: hello-world
          - os: windows-latest
            target: windows
            artifact: hello-world.exe

    steps:
    # ---------- åˆå§‹åŒ–æ­¥éª¤ ---------- 
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²ï¼ˆç”¨äºè‡ªåŠ¨ç”Ÿæˆchangelogï¼‰

    # ---------- ç¯å¢ƒå‡†å¤‡ ----------
    - name: Create output directory
      run: |
        mkdir -p bin
        echo "BIN_PATH=${{ github.workspace }}/bin" >> $GITHUB_ENV

    # ---------- ä¾èµ–å®‰è£… ----------
    - name: Install build tools (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc \
          cppcheck \
          mingw-w64  # Windowsäº¤å‰ç¼–è¯‘æ”¯æŒ

    - name: Install build tools (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install -y \
          mingw \
          cppcheck

    # ---------- é™æ€ä»£ç åˆ†æ ----------
    - name: Run cppcheck
      run: |
        mkdir -p reports
        cppcheck \
          --enable=all \
          --platform=unix64 \
          --xml-version=2 \
          --output-file=reports/cppcheck-${{ matrix.os }}.xml \
          src/
      continue-on-error: true  # åˆ†æå¤±è´¥ä¸ä¸­æ–­æ„å»º

    # ---------- æ„å»ºé˜¶æ®µ ----------
    - name: Build executable
      run: |
        case ${{ matrix.os }} in
          ubuntu-latest)
            gcc src/main.c -o "$BIN_PATH/${{ matrix.artifact }}"
            file "$BIN_PATH/${{ matrix.artifact }}"  # éªŒè¯æ–‡ä»¶ç±»å‹
            ;;
          windows-latest)
            x86_64-w64-mingw32-gcc src/main.c -o "$BIN_PATH/${{ matrix.artifact }}"
            ;;
        esac

    # ---------- æ„å»ºéªŒè¯ ----------
    - name: Validate artifacts
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "æ„å»ºäº§ç‰©åˆ—è¡¨:"
        ls -l "$BIN_PATH"
        
        # ä¸¥æ ¼æ£€æŸ¥æ–‡ä»¶å­˜åœ¨
        if [ ! -f "$BIN_PATH/${{ matrix.artifact }}" ]; then
          echo "::error::æ„å»ºäº§ç‰©ç¼ºå¤±: $BIN_PATH/${{ matrix.artifact }}"
          exit 1
        fi

    # ---------- å‘å¸ƒé˜¶æ®µ ----------
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: release-artifacts-${{ matrix.os }}
        path: |
          ${{ env.BIN_PATH }}/${{ matrix.artifact }}
          reports/cppcheck-${{ matrix.os }}.xml

    # ---------- åˆ›å»ºæ­£å¼ç‰ˆæœ¬ ----------
    - name: Create GitHub Release
      if: matrix.os == 'ubuntu-latest'  # åªåœ¨Linuxç¯å¢ƒæ‰§è¡Œä¸€æ¬¡
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: ${{ github.ref_name }}
        body: |
          ## ç‰ˆæœ¬å‘å¸ƒè¯´æ˜
          **æ„å»ºæ—¶é—´:** ${{ steps.get_timestamp.outputs.timestamp }}
          **æäº¤ä¿¡æ¯:**  
          ```plaintext
          ${{ github.event.head_commit.message }}
          ```
          
          ### åŒ…å«å†…å®¹
          - Linuxå¯æ‰§è¡Œæ–‡ä»¶ (`hello-world`)
          - Windowså¯æ‰§è¡Œæ–‡ä»¶ (`hello-world.exe`)
          - Cppcheckåˆ†ææŠ¥å‘Š
        draft: false
        prerelease: false
        files: |
          ${{ env.BIN_PATH }}/*
          reports/*.xml
        generate_release_notes: true  # è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜
        discussion_category_name: "Announcements"  # å…³è”è®¨è®ºåˆ†ç±»

    # ---------- è¾…åŠ©æ­¥éª¤ ----------
    - name: Get timestamp
      id: get_timestamp
      run: echo "timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

# ---------- é”™è¯¯å¤„ç† ----------
  notify-failure:
    needs: build-and-release
    if: ${{ failure() }}
    runs-on: ubuntu-latest
    steps:
      - name: Send failure notification
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš¨ ç‰ˆæœ¬å‘å¸ƒå¤±è´¥ï¼  
              é”™è¯¯è¯¦æƒ…: [æŸ¥çœ‹å·¥ä½œæµ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            })