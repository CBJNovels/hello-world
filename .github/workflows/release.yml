name: Tag-based Release

on:
  create:
    tags:
      - "*"

jobs:
  tag-release:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install cppcheck
      run: |
        if [ ${{ runner.os }} == 'Linux' ]; then
          sudo apt-get install -y cppcheck;
        elif [ ${{ runner.os }} == 'Windows' ]; then
          choco install cppcheck;
        fi

    - name: Run cppcheck
      run: |
        cppcheck --enable=all --xml --xml-version=2 src 2> cppcheck-report.xml
        cppcheck --enable=all src

    - name: Upload cppcheck results
      uses: actions/upload-artifact@v3
      with:
        name: cppcheck-report-${{ matrix.os }}
        path: cppcheck-report.xml

    - name: Build project
      run: |
        make clean
        make all

    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: hello_world${{ matrix.os == 'windows-latest' && '.exe' || '' }}
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}